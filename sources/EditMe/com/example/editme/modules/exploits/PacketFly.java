package com.example.editme.modules.exploits;

import com.example.editme.events.PacketEvent;
import com.example.editme.modules.Module;
import com.example.editme.settings.Setting;
import com.example.editme.util.client.BlockInteractionHelper;
import com.example.editme.util.setting.SettingsManager;
import java.util.ArrayList;
import java.util.List;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.client.CPacketPlayer.Position;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.math.BlockPos;
import net.minecraftforge.client.event.InputUpdateEvent;

@Module.Info(
   name = "Flight",
   description = "Makes you fly like an arab with a plane",
   category = Module.Category.EXPLOITS
)
public class PacketFly extends Module {
   private final CPacketPlayer[] packet = new CPacketPlayer[1];
   private final double[] ySpeed2 = new double[1];
   public final Setting speed = this.register(SettingsManager.floatBuilder("Speed").withValue((Number)0.1F).withMaximum(5.0F).withMinimum(0.0F).build());
   @EventHandler
   public Listener listener = new Listener(this::lambda$new$0, new Predicate[0]);
   private final int[] k = new int[1];
   private int teleportId;
   private final double[][] directionalSpeed = new double[1][1];
   private final int[] j = new int[1];
   private final SPacketPlayerPosLook[] packet2 = new SPacketPlayerPosLook[1];
   private final CPacketPlayer[] bounds = new CPacketPlayer[1];
   @EventHandler
   public Listener receiveListener = new Listener(this::lambda$new$2, new Predicate[0]);
   private final double[] ySpeed = new double[1];
   public final Setting noKick = this.register(SettingsManager.b("AntiKick", true));
   private List packets = new ArrayList();
   private final double[] n = new double[1];
   private final int[] i = new int[1];
   @EventHandler
   public Listener sendListener = new Listener(this::lambda$new$1, new Predicate[0]);

   public void onEnable() {
      if (mc.field_71441_e != null) {
         this.teleportId = 0;
         this.packets.clear();
         Position var1 = new Position(mc.field_71439_g.field_70165_t, 1.0D, mc.field_71439_g.field_70161_v, mc.field_71439_g.field_70122_E);
         this.packets.add(var1);
         mc.field_71439_g.field_71174_a.func_147297_a(var1);
      }

   }

   private void lambda$new$1(PacketEvent.Send var1) {
      if (var1.getPacket() instanceof CPacketPlayer && !(var1.getPacket() instanceof Position)) {
         var1.cancel();
      }

      if (var1.getPacket() instanceof CPacketPlayer) {
         this.packet[0] = (CPacketPlayer)var1.getPacket();
         if (this.packets.contains(this.packet[0])) {
            this.packets.remove(this.packet[0]);
         } else {
            var1.cancel();
         }
      }

   }

   private void move(double var1, double var3, double var5) {
      Position var7 = new Position(mc.field_71439_g.field_70165_t + var1, mc.field_71439_g.field_70163_u + var3, mc.field_71439_g.field_70161_v + var5, mc.field_71439_g.field_70122_E);
      this.packets.add(var7);
      mc.field_71439_g.field_71174_a.func_147297_a(var7);
      Position var8 = new Position(mc.field_71439_g.field_70165_t + var1, 1.0D, mc.field_71439_g.field_70161_v + var5, mc.field_71439_g.field_70122_E);
      this.packets.add(var8);
      mc.field_71439_g.field_71174_a.func_147297_a(var8);
      ++this.teleportId;
      mc.field_71439_g.field_71174_a.func_147297_a(new CPacketConfirmTeleport(this.teleportId - 1));
      mc.field_71439_g.field_71174_a.func_147297_a(new CPacketConfirmTeleport(this.teleportId));
      mc.field_71439_g.field_71174_a.func_147297_a(new CPacketConfirmTeleport(this.teleportId + 1));
   }

   private void lambda$new$0(InputUpdateEvent var1) {
      if (this.teleportId <= 0) {
         this.bounds[0] = new Position(mc.field_71439_g.field_70165_t, 1.0D, mc.field_71439_g.field_70161_v, mc.field_71439_g.field_70122_E);
         this.packets.add(this.bounds[0]);
         mc.field_71439_g.field_71174_a.func_147297_a(this.bounds[0]);
      } else {
         mc.field_71439_g.func_70016_h(0.0D, 0.0D, 0.0D);
         if (mc.field_71441_e.func_184144_a(mc.field_71439_g, mc.field_71439_g.func_174813_aQ().func_72321_a(-0.0625D, 0.0D, -0.0625D)).isEmpty()) {
            this.ySpeed[0] = 0.0D;
            if (mc.field_71474_y.field_74314_A.func_151470_d()) {
               if ((Boolean)this.noKick.getValue()) {
                  this.ySpeed2[0] = mc.field_71439_g.field_70173_aa % 20 == 0 ? 0.03999999910593033D : 0.06199999898672104D;
               } else {
                  this.ySpeed2[0] = 0.06199999898672104D;
               }
            } else if (mc.field_71474_y.field_74311_E.func_151470_d()) {
               this.ySpeed2[0] = -0.062D;
            } else {
               if (mc.field_71441_e.func_184144_a(mc.field_71439_g, mc.field_71439_g.func_174813_aQ().func_72321_a(-0.0625D, -0.0625D, -0.0625D)).isEmpty()) {
                  if (mc.field_71439_g.field_70173_aa % 4 == 0) {
                     this.n[0] = (double)((Boolean)this.noKick.getValue() ? -0.04F : 0.0F);
                  } else {
                     this.n[0] = 0.0D;
                  }
               } else {
                  this.n[0] = 0.0D;
               }

               this.ySpeed2[0] = this.n[0];
            }

            this.directionalSpeed[0] = BlockInteractionHelper.directionSpeed((double)(Float)this.speed.getValue());
            if (!mc.field_71474_y.field_74314_A.func_151470_d() && !mc.field_71474_y.field_74311_E.func_151470_d() && !mc.field_71474_y.field_74351_w.func_151470_d() && !mc.field_71474_y.field_74368_y.func_151470_d() && !mc.field_71474_y.field_74366_z.func_151470_d() && !mc.field_71474_y.field_74370_x.func_151470_d()) {
               if ((Boolean)this.noKick.getValue() && mc.field_71441_e.func_184144_a(mc.field_71439_g, mc.field_71439_g.func_174813_aQ().func_72321_a(-0.0625D, -0.0625D, -0.0625D)).isEmpty()) {
                  if (mc.field_71474_y.field_74314_A.func_151470_d()) {
                     mc.field_71439_g.func_70016_h(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : 0.02999999910593033D, 0.0D);
                     this.move(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : 0.02999999910593033D, 0.0D);
                  } else {
                     mc.field_71439_g.func_70016_h(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : -0.03999999910593033D, 0.0D);
                     this.move(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : -0.03999999910593033D, 0.0D);
                  }
               }
            } else if (this.directionalSpeed[0][0] != 0.0D || this.ySpeed2[0] != 0.0D || this.directionalSpeed[0][1] != 0.0D) {
               int var10002;
               if (mc.field_71439_g.field_71158_b.field_78901_c && (mc.field_71439_g.field_70702_br != 0.0F || mc.field_71439_g.field_191988_bg != 0.0F)) {
                  mc.field_71439_g.func_70016_h(0.0D, 0.0D, 0.0D);
                  this.move(0.0D, -666.0D, 0.0D);

                  for(this.i[0] = 0; this.i[0] <= 3; var10002 = this.i[0]++) {
                     mc.field_71439_g.func_70016_h(0.0D, this.ySpeed2[0] * (double)this.i[0], 0.0D);
                     this.move(0.0D, this.ySpeed2[0] * (double)this.i[0], 0.0D);
                  }
               } else if (mc.field_71439_g.field_71158_b.field_78901_c) {
                  mc.field_71439_g.func_70016_h(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : 0.02999999910593033D, 0.0D);
                  this.move(0.0D, mc.field_71439_g.field_70173_aa % 2 == 0 ? 0.03999999910593033D : 0.02999999910593033D, 0.0D);
               } else {
                  for(this.k[0] = 0; this.k[0] <= 2; var10002 = this.k[0]++) {
                     mc.field_71439_g.func_70016_h(this.directionalSpeed[0][0] * (double)this.k[0], this.ySpeed2[0] * (double)this.k[0], this.directionalSpeed[0][1] * (double)this.k[0]);
                     this.move(this.directionalSpeed[0][0] * (double)this.k[0], this.ySpeed2[0] * (double)this.k[0], this.directionalSpeed[0][1] * (double)this.k[0]);
                  }
               }
            }
         }

      }
   }

   private void lambda$new$2(PacketEvent.Receive var1) {
      if (var1.getPacket() instanceof SPacketPlayerPosLook) {
         this.packet2[0] = (SPacketPlayerPosLook)var1.getPacket();
         if (mc.field_71439_g.func_70089_S() && mc.field_71441_e.func_175667_e(new BlockPos(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u, mc.field_71439_g.field_70161_v)) && !(mc.field_71462_r instanceof GuiDownloadTerrain)) {
            if (this.teleportId <= 0) {
               this.teleportId = this.packet2[0].func_186965_f();
            } else {
               var1.cancel();
            }
         }
      }

   }
}
