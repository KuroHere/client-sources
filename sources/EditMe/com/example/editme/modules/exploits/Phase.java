package com.example.editme.modules.exploits;

import com.example.editme.events.AddCollisionBoxToListEvent;
import com.example.editme.events.PacketEvent;
import com.example.editme.modules.Module;
import com.example.editme.settings.Setting;
import com.example.editme.util.client.MathUtil;
import com.example.editme.util.setting.SettingsManager;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketEntityAction.Action;
import net.minecraft.network.play.client.CPacketPlayer.PositionRotation;
import net.minecraft.network.play.client.CPacketPlayer.Rotation;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.util.math.BlockPos;
import net.minecraftforge.client.event.RenderBlockOverlayEvent;

@Module.Info(
   name = "Phase",
   category = Module.Category.EXPLOITS
)
public class Phase extends Module {
   @EventHandler
   public Listener renderBlockOverlayEventListener = new Listener(Phase::lambda$new$0, new Predicate[0]);
   private Setting accelerationTimer = this.register(SettingsManager.booleanBuilder("Acceleration Timer").withValue(false).build());
   private Setting antiFallBack = this.register(SettingsManager.booleanBuilder("Anti Fall Back").withValue(true).build());
   private Setting shiftDelay = this.register(SettingsManager.integerBuilder("Shift Delay").withMinimum(1).withMaximum(20).withValue((int)10).build());
   private BlockPos startPos;
   private boolean fastShift = true;
   private int phaseShift = 0;
   @EventHandler
   public Listener collideWithBlock = new Listener(this::lambda$new$1, new Predicate[0]);
   private boolean timer = false;
   @EventHandler
   public Listener sendPacket = new Listener(Phase::lambda$new$2, new Predicate[0]);
   private Setting speedMod = this.register(SettingsManager.integerBuilder("Speed").withMinimum(0).withMaximum(50).withValue((int)25).build());

   public void onUpdate() {
      if (mc.field_71439_g != null) {
         if (this.startPos == null) {
            this.startPos = mc.field_71439_g.func_180425_c();
         }

         int var1 = (Integer)this.speedMod.getValue() / 10;
         double[] var2 = MathUtil.directionSpeed((double)(this.fastShift ? 0.0225F * (float)var1 : 0.0224F * (float)var1));
         if (this.phaseShift >= (Integer)this.shiftDelay.getValue()) {
            if (mc.field_71439_g.func_180425_c().func_177958_n() == this.startPos.func_177958_n() && mc.field_71439_g.func_180425_c().func_177952_p() == this.startPos.func_177952_p() && mc.field_71439_g.func_180425_c().func_177956_o() - this.startPos.func_177956_o() < 2) {
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketEntityAction(mc.field_71439_g, Action.START_SNEAKING));
            }

            this.phaseShift = 0;
         } else if (this.phaseShift == 0) {
            mc.field_71439_g.field_71174_a.func_147297_a(new CPacketEntityAction(mc.field_71439_g, Action.STOP_SNEAKING));
            ++this.phaseShift;
         } else {
            ++this.phaseShift;
         }

         if ((Boolean)this.accelerationTimer.getValue() && this.timer) {
            mc.field_71428_T.field_194149_e = 40.0F;
         } else {
            mc.field_71428_T.field_194149_e = 50.0F;
         }

         mc.field_71439_g.field_71174_a.func_147297_a(new PositionRotation(mc.field_71439_g.field_70165_t + var2[0], mc.field_71439_g.field_70163_u + (mc.field_71474_y.field_74314_A.func_151470_d() ? (this.fastShift ? 0.0625D : 0.0624D) : 1.0E-8D) - (mc.field_71474_y.field_74311_E.func_151470_d() ? (this.fastShift ? 0.0625D : 0.0624D) : 2.0E-8D), mc.field_71439_g.field_70161_v + var2[1], mc.field_71439_g.field_70177_z, mc.field_71439_g.field_70125_A, false));
         mc.field_71439_g.field_71174_a.func_147297_a(new PositionRotation(mc.field_71439_g.field_70165_t, -666.0D, mc.field_71439_g.field_70161_v, mc.field_71439_g.field_70177_z, mc.field_71439_g.field_70125_A, true));
         mc.field_71439_g.field_71174_a.func_147297_a(new CPacketEntityAction(mc.field_71439_g, Action.START_FALL_FLYING));
         mc.field_71439_g.func_70107_b(mc.field_71439_g.field_70165_t + var2[0], mc.field_71439_g.field_70163_u + (mc.field_71474_y.field_74314_A.func_151470_d() ? (this.fastShift ? 0.0625D * (double)var1 : 0.0624D * (double)var1) : 1.0E-8D) - (mc.field_71474_y.field_74311_E.func_151470_d() ? (this.fastShift ? 0.0625D * (double)var1 : 0.0624D * (double)var1) : 2.0E-8D), mc.field_71439_g.field_70161_v + var2[1]);
         this.fastShift = !this.fastShift;
         this.timer = !this.timer;
         mc.field_71439_g.field_70159_w = mc.field_71439_g.field_70181_x = mc.field_71439_g.field_70179_y = 0.0D;
         mc.field_71439_g.field_70145_X = this.fastShift;
      }
   }

   public void onEnable() {
      if (mc.field_71439_g != null) {
         this.startPos = mc.field_71439_g.func_180425_c();
      }

   }

   private void lambda$new$1(AddCollisionBoxToListEvent var1) {
      if (mc.field_71439_g != null) {
         if (!this.fastShift) {
            var1.setEntityBox((AxisAlignedBB)null);
         }

      }
   }

   private static void lambda$new$0(RenderBlockOverlayEvent var0) {
      var0.setCanceled(true);
   }

   private static void lambda$new$2(PacketEvent.Send var0) {
      if (var0.getPacket() instanceof Rotation) {
         var0.cancel();
      }

   }

   public void onDisable() {
      if (mc.field_71439_g != null) {
         mc.field_71428_T.field_194149_e = 50.0F;
         if ((Boolean)this.antiFallBack.getValue()) {
            mc.field_71439_g.field_71174_a.func_147297_a(new PositionRotation(mc.field_71439_g.field_70165_t, mc.field_71439_g.field_70163_u + 0.0625D * (double)((Integer)this.speedMod.getValue() / 10), mc.field_71439_g.field_70161_v, mc.field_71439_g.field_70177_z, mc.field_71439_g.field_70125_A, false));
         }

      }
   }
}
