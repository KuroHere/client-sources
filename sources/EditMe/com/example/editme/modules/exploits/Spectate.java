package com.example.editme.modules.exploits;

import com.example.editme.events.PacketEvent;
import com.example.editme.modules.Module;
import com.example.editme.util.client.EntityUtil;
import com.example.editme.util.render.FakePlayer;
import java.util.Iterator;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.GuiMainMenu;
import net.minecraft.client.gui.GuiMultiplayer;
import net.minecraft.entity.Entity;

@Module.Info(
   name = "Spectate",
   category = Module.Category.EXPLOITS
)
public class Spectate extends Module {
   private FakePlayer fakePlayer;
   @EventHandler
   private final Listener sendListener = new Listener(Spectate::lambda$new$0, new Predicate[0]);
   public static Entity entity = null;

   public void onEnable() {
      if (mc.field_71439_g != null && mc.func_147104_D() != null && !(mc.field_71462_r instanceof GuiMainMenu) && !(mc.field_71462_r instanceof GuiMultiplayer)) {
         if (entity == null) {
            entity = EntityUtil.getClosestEntity();
            if (entity == null) {
               this.sendNotification("No entity auto-found. Please specify one manually using .spectate <name>");
               return;
            }
         }

         mc.field_71439_g.field_70145_X = true;
         this.fakePlayer = new FakePlayer();
         mc.field_71441_e.func_73027_a(-420, this.fakePlayer);
      } else {
         this.disable();
      }
   }

   public void onUpdate() {
      Iterator var1 = Minecraft.func_71410_x().field_71441_e.field_72996_f.iterator();

      while(var1.hasNext()) {
         Entity var2 = (Entity)var1.next();
         if (var2.func_70005_c_().equalsIgnoreCase(entity.func_70005_c_())) {
            entity.func_70107_b(var2.field_70165_t, var2.field_70163_u, var2.field_70161_v);
            entity.field_70125_A = var2.field_70125_A;
            entity.field_70177_z = var2.field_70177_z;
         }
      }

      mc.field_71439_g.func_82149_j(entity);
      mc.field_71439_g.field_70159_w = 0.0D;
      mc.field_71439_g.field_70181_x = 0.0D;
      mc.field_71439_g.field_70179_y = 0.0D;
      entity.func_82142_c(true);
   }

   public void onDisable() {
      if (entity != null) {
         entity.func_82142_c(false);
      }

      if (mc.field_71439_g != null && mc.func_147104_D() != null) {
         mc.field_71439_g.field_70145_X = false;
         mc.field_71441_e.func_73028_b(-420);
         this.fakePlayer = null;
      }
   }

   private static void lambda$new$0(PacketEvent.Send var0) {
      if (mc.func_147104_D() != null) {
         var0.cancel();
      }

   }
}
