package me.darki.konas.module.modules.exploit;

import cookiedragon.eventsystem.Subscriber;
import me.darki.konas.event.events.CollisionBoxEvent;
import me.darki.konas.event.events.PacketEvent;
import me.darki.konas.event.events.PlayerMoveEvent;
import me.darki.konas.event.events.UpdateEvent;
import me.darki.konas.mixin.mixins.ISPacketPlayerPosLook;
import me.darki.konas.module.Module;
import me.darki.konas.setting.Setting;
import me.darki.konas.util.client.PlayerUtils;
import me.darki.konas.util.timer.Timer;
import net.minecraft.block.Block;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketPlayerPosLook;


public class AntiVoid extends Module {
    private Setting<Boolean> jesus = new Setting<>("Float", false);

    public AntiVoid() {
        super("AntiVoid", Category.EXPLOIT, "NoVoid");
    }

    boolean aboveVoid = true;
    private Timer voidTimer = new Timer();

    @Subscriber
    public void onUpdate(UpdateEvent event) {
        if(mc.player == null || mc.world == null) return;
        if(PlayerUtils.isPlayerAboveVoid() && mc.player.posY <= 1.0D) {
            if (aboveVoid && voidTimer.hasPassed(1000)) {
                aboveVoid = false;
                mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 0.1, mc.player.posZ, false));
            }
        } else {
            aboveVoid = true;
        }
    }

    @Subscriber
    public void onPlayerMove(PlayerMoveEvent event) {
        if (jesus.getValue() && PlayerUtils.isPlayerAboveVoid()) {
            if (mc.player.posY <= 1) {
                event.setY(-0.01);
            }
        }
    }

    @Subscriber
    public void onReceive(PacketEvent.Receive event) {
        if (event.getPacket() instanceof SPacketPlayerPosLook) {
            if (!(mc.currentScreen instanceof GuiDownloadTerrain)) {
                SPacketPlayerPosLook packet = (SPacketPlayerPosLook) event.getPacket();
                ((ISPacketPlayerPosLook) packet).setYaw(mc.player.rotationYaw);
                ((ISPacketPlayerPosLook) packet).setPitch(mc.player.rotationPitch);
                packet.getFlags().remove(SPacketPlayerPosLook.EnumFlags.X_ROT);
                packet.getFlags().remove(SPacketPlayerPosLook.EnumFlags.Y_ROT);
            }
        }
    }

}
