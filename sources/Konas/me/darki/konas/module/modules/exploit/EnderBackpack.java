package me.darki.konas.module.modules.exploit;

import cookiedragon.eventsystem.Subscriber;
import me.darki.konas.event.events.LoadGuiEvent;
import me.darki.konas.event.events.PacketEvent;
import me.darki.konas.event.events.PlayerUpdateEvent;
import me.darki.konas.event.events.ProcessRightClickBlockEvent;
import me.darki.konas.mixin.mixins.ISPacketCloseWindow;
import me.darki.konas.module.Module;
import net.minecraft.block.Block;
import net.minecraft.block.BlockContainer;
import net.minecraft.client.gui.inventory.GuiContainer;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.init.Blocks;
import net.minecraft.inventory.ClickType;
import net.minecraft.network.play.client.CPacketClickWindow;
import net.minecraft.network.play.client.CPacketCloseWindow;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.network.play.server.SPacketCloseWindow;
import net.minecraft.util.EnumHand;

public class EnderBackpack extends Module {

    private GuiContainer screen;
    private boolean isBackpacked;
    private boolean closeGui = false;

    public EnderBackpack() {
        super("EnderBackpack", "Closes your enderchest GUI and allows you to open it whenever you want", Category.EXPLOIT);
    }

    public void onDisable() {
        if (mc.world != null) {
            mc.player.connection.sendPacket(new CPacketCloseWindow(mc.player.inventoryContainer.windowId));
            isBackpacked = false;
            closeGui = false;
            screen = null;
        }
    }

    @Subscriber
    public void onUpdate(PlayerUpdateEvent event) {
        if (isBackpacked && closeGui) {
            if (mc.currentScreen instanceof GuiContainer && !(mc.currentScreen instanceof GuiInventory)) {
                mc.currentScreen = null;
                closeGui = false;
            }
        }
    }

    @Subscriber
    public void onLoadGui(LoadGuiEvent event) {
        if (event.getGui() instanceof GuiContainer && !(event.getGui() instanceof GuiInventory)) {
            this.screen = (GuiContainer) event.getGui();
        } else if (event.getGui() instanceof GuiInventory) {
            if (isBackpacked && screen != null) {
                closeGui = false;
                event.setCancelled(true);
                mc.displayGuiScreen(screen);
            }
        }
    }

    public void onPacketReceive(PacketEvent.Receive event) {
        if (event.getPacket() instanceof SPacketCloseWindow) {
            final SPacketCloseWindow packetCloseWindow = (SPacketCloseWindow) event.getPacket();
            if (screen != null && ((ISPacketCloseWindow) packetCloseWindow).getWindowId() == screen.inventorySlots.windowId) {
                isBackpacked = false;
                closeGui = false;
                screen = null;
            }
        }
    }

    @Subscriber
    public void onRightClickBlock(ProcessRightClickBlockEvent event) {
        if (event.getPos() != null) {
            final Block block = mc.world.getBlockState(event.getPos()).getBlock();
            if (block == Blocks.ENDER_CHEST) {
                float dX = (float) (event.getVec().x - (double) event.getPos().getX());
                float dY = (float) (event.getVec().y - (double) event.getPos().getY());
                float dZ = (float) (event.getVec().z - (double) event.getPos().getZ());
                mc.player.connection.sendPacket(new CPacketPlayerTryUseItemOnBlock(event.getPos(), event.getDirection(), EnumHand.MAIN_HAND, dX, dY, dZ));
                isBackpacked = true;
            } else if (block instanceof BlockContainer) {
                isBackpacked = false;
                closeGui = false;
                screen = null;
            }
        }
    }

    @Subscriber
    public void onPacketSend(PacketEvent.Send event) {
        if (event.getPacket() instanceof CPacketCloseWindow) {
            if (screen != null && isBackpacked) {
                event.setCancelled(true);
            }
        } else if (event.getPacket() instanceof CPacketClickWindow) {
            final CPacketClickWindow packetClickWindow = (CPacketClickWindow) event.getPacket();
            if (packetClickWindow.getClickType().equals(ClickType.THROW) && isBackpacked && screen != null) {
                closeGui = true;
            } else if (packetClickWindow.getClickType().equals(ClickType.THROW) && !isBackpacked) {
                closeGui = false;
                screen = null;
            }
        }
    }

}
