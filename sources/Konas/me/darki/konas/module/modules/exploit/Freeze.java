package me.darki.konas.module.modules.exploit;

import cookiedragon.eventsystem.Subscriber;
import me.darki.konas.event.events.PacketEvent;
import me.darki.konas.event.events.PlayerMoveEvent;
import me.darki.konas.module.Module;
import me.darki.konas.util.timer.Timer;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketPlayer;

public class Freeze extends Module {
    private Timer timer = new Timer();

    public Freeze() {
        super("Freeze", "Rubberbands you and gives you temporary godmode on some servers", Category.EXPLOIT);
    }

    private int teleportId = 0;

    @Subscriber
    public void onPlayerMoveEvent(PlayerMoveEvent event) {
        if (teleportId != 0) {
            event.setCancelled(true);
            if (timer.hasPassed(2850)) {
                toggle();
            }
        }
    }

    public void onEnable() {
        if (mc.player == null || mc.world == null) {
            toggle();
            return;
        }

        teleportId = 0;

        mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 3, mc.player.posZ, mc.player.onGround));
    }

    public void onDisable() {
        if (mc.player == null || mc.world == null) {
            return;
        }

        mc.player.connection.sendPacket(new CPacketConfirmTeleport(teleportId));
    }

    @Subscriber
    public void onPacketSend(PacketEvent.Send event) {
        if (event.getPacket() instanceof CPacketConfirmTeleport) {
            teleportId = ((CPacketConfirmTeleport) event.getPacket()).getTeleportId();
            timer.reset();
            event.setCancelled(true);
        }
    }
}
